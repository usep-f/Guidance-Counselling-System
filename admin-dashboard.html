<!doctype html>
<html lang="en" class="guard-pending">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Guidance System</title>

    <!-- INSTANT GUARD: prevents any flash before external CSS loads -->
    <style>
      html.guard-pending body {
        visibility: hidden;
      }
    </style>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="admin.css" />
  </head>

  <body>
    <!-- NAVBAR (same structure as index.html) -->
    <header class="site-header" id="top">
      <nav class="navbar">
        <a class="brand" href="index.html#top" aria-label="Guidance System Home">
          <span class="brand__logo" aria-hidden="true"></span>
          <span class="brand__text">Guidance System</span>
        </a>

        <button
          class="nav-toggle"
          type="button"
          aria-label="Toggle navigation"
          aria-expanded="false"
        >
          <span class="nav-toggle__bar"></span>
          <span class="nav-toggle__bar"></span>
          <span class="nav-toggle__bar"></span>
        </button>

        <div class="nav-links" data-nav>
          <a class="nav-link nav-link--dashboard" data-dashboard-link href="#">
            Dashboard
          </a>
          <a class="nav-link" href="index.html#home">Home</a>
          <a class="nav-link" href="index.html#about">About Us</a>
          <a class="nav-link" href="index.html#services">Services</a>
          <a class="nav-link" href="index.html#how">How it Works</a>
          <a class="nav-link" href="index.html#contact">Contact</a>
        </div>

        <a class="btn btn--pill btn--primary nav-cta" href="index.html#login">
          Logout
          <span class="btn__icon" aria-hidden="true">→</span>
        </a>
      </nav>
    </header>

    <main class="page">
      <header class="page-hero">
        <h1 class="page-title">Admin Dashboard</h1>
        <p class="page-subtitle">
          Analytics summary of student concerns categorized by emotional states (stress, anxiety,
          depression) and possible environmental triggers (family, financial, academic, peer).
        </p>
      </header>

      <div class="dashboard-tabs" role="tablist" aria-label="Admin dashboard tabs">
        <a class="dashboard-tab is-active" href="#admin-analytics" data-dashboard-tab>Analytics</a>
        <a class="dashboard-tab" href="#admin-users" data-dashboard-tab>Enrolled Users</a>
        <a class="dashboard-tab" href="#admin-appointments" data-dashboard-tab>Appointments</a>
        <a class="dashboard-tab" href="#admin-inquiries" data-dashboard-tab>Inquiries</a>
      </div>

      <section class="admin-wrap">
        <section class="dashboard-section" id="admin-analytics" aria-label="Admin analytics">
          <!-- Filters -->
          <div class="admin-filters" aria-label="Dashboard filters">
            <div class="admin-filter">
              <label class="admin-label" for="timeRange">Time Range</label>
              <select class="admin-control" id="timeRange" name="timeRange">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="all">All time</option>
              </select>
            </div>

            <div class="admin-filter">
              <label class="admin-label" for="gradeLevel">Year Level</label>
              <select class="admin-control" id="gradeLevel" name="gradeLevel">
                <option value="all" selected>All students</option>
                <option value="1st year">1st Year</option>
                <option value="2nd year">2nd Year</option>
                <option value="3rd year">3rd Year</option>
                <option value="4th year">4th Year</option>
                <option value="irregular">Irregular</option>
              </select>
            </div>

            <div class="admin-filter admin-filter--stretch">
              <label class="admin-label" for="searchStudent">Search (Student ID / Name)</label>
              <input
                class="admin-control"
                id="searchStudent"
                name="searchStudent"
                type="text"
                placeholder="e.g., 2024-00123 or Juan Dela Cruz"
                autocomplete="off"
              />
            </div>

            <div class="admin-filter admin-filter--actions">
              <button class="btn btn--pill btn--ghost" type="button" id="btnReset">
                Reset
              </button>
              <button class="btn btn--pill btn--primary" type="button" id="btnExport">
                Export Summary
                <span class="btn__icon" aria-hidden="true">→</span>
              </button>
            </div>
          </div>

          <!-- KPI cards -->
          <div class="admin-kpis" aria-label="Key metrics">
            <article class="admin-kpi">
              <p class="admin-kpi__label">Total Concerns Logged</p>
              <h3 class="admin-kpi__value" id="kpiTotalConcerns">0</h3>
              <p class="admin-kpi__hint" id="kpiTotalConcernsHint">Across selected range</p>
            </article>

            <article class="admin-kpi">
              <p class="admin-kpi__label">Most Common Emotion</p>
              <h3 class="admin-kpi__value" id="kpiTopEmotion">-</h3>
              <p class="admin-kpi__hint" id="kpiTopEmotionHint">Based on emotional states</p>
            </article>

            <article class="admin-kpi">
              <p class="admin-kpi__label">Most Common Trigger</p>
              <h3 class="admin-kpi__value" id="kpiTopTrigger">-</h3>
              <p class="admin-kpi__hint" id="kpiTopTriggerHint">Based on triggers</p>
            </article>

            <article class="admin-kpi">
              <p class="admin-kpi__label">Pending Items</p>
              <h3 class="admin-kpi__value" id="kpiPending">0</h3>
              <p class="admin-kpi__hint">Appointments and inquiries</p>
            </article>
          </div>

          <!-- Charts -->
          <div class="admin-grid">
            <section class="admin-card" aria-label="Emotional states chart">
              <div class="admin-card__head">
                <h2 class="admin-card__title">Emotional States</h2>
                <p class="admin-card__sub">Stress, Anxiety, Depression</p>
              </div>

              <div class="barlist" id="chartEmotions" role="list"></div>
            </section>

            <section class="admin-card" aria-label="Environmental triggers chart">
              <div class="admin-card__head">
                <h2 class="admin-card__title">Environmental Triggers</h2>
                <p class="admin-card__sub">Family, Financial, Academic, Peer</p>
              </div>

              <div class="barlist" id="chartTriggers" role="list"></div>
            </section>

            <section class="admin-card admin-card--wide" aria-label="Summary table">
              <div class="admin-card__head">
                <h2 class="admin-card__title">Recent Summary</h2>
                <p class="admin-card__sub">Sample rows (replace with real DB later)</p>
              </div>

              <div class="admin-tablewrap">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Student</th>
                      <th>Emotion</th>
                      <th>Trigger</th>
                      <th>Severity</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="recentTable"></tbody>
                </table>
              </div>

              <div class="admin-note">
                Tip: once you connect backend data, you can auto-generate these insights for the guidance
                coordinator to approve schedules and review counseling summaries.
              </div>
            </section>
          </div>
        </section>

        <section class="dashboard-section" id="admin-users" aria-label="Enrolled users">
          <header class="admin-panel__head">
            <div>
              <h2 class="admin-panel__title">Enrolled Users</h2>
              <p class="admin-panel__sub">
                Review student profiles and recent appointment history.
              </p>
            </div>
          </header>

          <div class="admin-filters admin-filters--stack" aria-label="Enrolled user filters">
            <div class="admin-filter admin-filter--stretch">
              <label class="admin-label" for="userSearch">Search (Name / ID)</label>
              <input
                class="admin-control"
                id="userSearch"
                name="userSearch"
                type="text"
                placeholder="Search enrolled students"
                autocomplete="off"
              />
            </div>
            <div class="admin-filter">
              <label class="admin-label" for="userYear">Year Level</label>
              <select class="admin-control" id="userYear" name="userYear">
                <option value="all" selected>All levels</option>
                <option value="1st year">1st Year</option>
                <option value="2nd year">2nd Year</option>
                <option value="3rd year">3rd Year</option>
                <option value="4th year">4th Year</option>
                <option value="irregular">Irregular</option>
              </select>
            </div>
            <div class="admin-filter">
              <label class="admin-label" for="userCourse">Course</label>
              <select class="admin-control" id="userCourse" name="userCourse">
                <option value="all" selected>All courses</option>
                <option value="BIT CPT">BIT CPT</option>
                <option value="BTVTED CP">BTVTED CP</option>
                <option value="BTVTED MT">BTVTED MT</option>
                <option value="BTVTED CT">BTVTED CT</option>
                <option value="BTVTED FSM">BTVTED FSM</option>
                <option value="BTVTED AT">BTVTED AT</option>
                <option value="BTVTED ELX/ELT">BTVTED ELX/ELT</option>
              </select>
            </div>
          </div>

          <div class="admin-list" id="enrolledList" aria-live="polite"></div>
        </section>

        <section class="dashboard-section" id="admin-appointments" aria-label="Appointments">
          <header class="admin-panel__head">
            <div>
              <h2 class="admin-panel__title">Appointments</h2>
              <p class="admin-panel__sub">
                Track pending and completed appointments. Accepted sessions can be opened for notes.
              </p>
            </div>
          </header>

          <div class="admin-pilltabs" role="tablist" aria-label="Appointment filters">
            <button class="admin-pilltab is-active" type="button" data-appt-filter="pending">
              Pending
            </button>
            <button class="admin-pilltab" type="button" data-appt-filter="accepted">
              Accepted
            </button>
            <button class="admin-pilltab" type="button" data-appt-filter="completed">
              Completed
            </button>
          </div>

          <div class="admin-list" id="appointmentList" aria-live="polite"></div>

          <div class="admin-pagination" id="paginationControls" hidden>
            <button class="btn btn--sm btn--pill btn--ghost" id="prevPageBtn" disabled type="button">← Previous</button>
            <span class="admin-pagination__info" id="pageIndicator">Page 1</span>
            <button class="btn btn--sm btn--pill btn--ghost" id="nextPageBtn" type="button">Next →</button>
          </div>
        </section>

        <!-- Inquiries Section -->
        <section class="dashboard-section" id="admin-inquiries" aria-label="Private Inquiries">
          <header class="admin-panel__head">
            <div>
              <h2 class="admin-panel__title">Private Inquiries</h2>
              <p class="admin-panel__sub">Confidential messages sent by students.</p>
            </div>
          </header>

          <div class="admin-list" id="inquiryList" aria-live="polite">
            <p class="admin-empty">Loading inquiries...</p>
          </div>
        </section>
      </section>

      <div class="admin-modal" id="userModal" aria-hidden="true">
        <div class="admin-modal__overlay" data-modal-close></div>
        <div class="admin-modal__panel" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
          <header class="admin-modal__head">
            <div>
              <p class="admin-modal__eyebrow">Student Profile</p>
              <h2 class="admin-modal__title" id="userModalTitle">Student Name</h2>
            </div>
            <button class="admin-modal__close" type="button" data-modal-close aria-label="Close">
              ✕
            </button>
          </header>
          <div class="admin-modal__body" id="userModalBody"></div>
        </div>
      </div>

      <div class="admin-modal" id="appointmentModal" aria-hidden="true">
        <div class="admin-modal__overlay" data-modal-close></div>
        <div class="admin-modal__panel" role="dialog" aria-modal="true" aria-labelledby="appointmentModalTitle">
          <header class="admin-modal__head">
            <div>
              <p class="admin-modal__eyebrow">Appointment Details</p>
              <h2 class="admin-modal__title" id="appointmentModalTitle">Appointment</h2>
            </div>
            <button class="admin-modal__close" type="button" data-modal-close aria-label="Close">
              ✕
            </button>
          </header>
          <div class="admin-modal__body" id="appointmentModalBody"></div>
        </div>
      </div>
      <div class="admin-modal" id="inquiryModal" aria-hidden="true">
        <div class="admin-modal__overlay" data-modal-close></div>
        <div class="admin-modal__panel" role="dialog" aria-modal="true" aria-labelledby="inquiryModalTitle">
          <header class="admin-modal__head">
            <div>
              <p class="admin-modal__eyebrow" id="inquiryModalEyebrow">Message Detail</p>
              <h2 class="admin-modal__title" id="inquiryModalTitle">Inquiry</h2>
            </div>
            <button class="admin-modal__close" type="button" data-modal-close aria-label="Close">
              ✕
            </button>
          </header>
          <div class="admin-modal__body" id="inquiryModalBody"></div>
          
          <!-- Shared Form/Footer area -->
          <div class="admin-modal__footer admin-modal__footer--column">
            <!-- Toggable response input -->
            <div id="inquiryResponseForm" hidden>
              <div class="inq-field inq-field--full">
                <label class="inq-label" for="adminResponseMessage">Counselor Response</label>
                <textarea 
                  class="inq-control inq-textarea" 
                  id="adminResponseMessage" 
                  rows="6" 
                  placeholder="Type your response here..."
                ></textarea>
              </div>
            </div>

            <!-- Global Actions -->
            <div class="admin-modal__actions">
              <button class="btn btn--pill btn--ghost" type="button" data-modal-close>Close</button>
              <button class="btn btn--pill btn--primary" id="btnSubmitInquiryResponse" type="button" hidden>
                Send Response
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="admin-modal" id="confirmAcceptModal" aria-hidden="true">
        <div class="admin-modal__overlay" data-modal-close></div>
        <div class="admin-modal__panel admin-modal__panel--sm" role="dialog" aria-modal="true">
          <header class="admin-modal__head">
            <h2 class="admin-modal__title">Confirm Appointment</h2>
            <button class="admin-modal__close" type="button" data-modal-close aria-label="Close">✕</button>
          </header>
          <div class="admin-modal__body">
            <p>Are you sure you want to accept this appointment request? This will block the selected slot and notify the student.</p>
          </div>
          <footer class="admin-modal__footer">
            <button class="btn btn--pill btn--ghost" type="button" data-modal-close>Cancel</button>
            <button class="btn btn--pill btn--primary" id="btnConfirmAccept" type="button">Confirm & Accept</button>
          </footer>
        </div>
      </div>
    </main>

    <!-- FOOTER (same structure as index.html) -->
    <footer class="footer" aria-label="Site footer">
      <div class="footer__inner">
        <div class="footer__top">
          <div class="footer__col footer__brand">
            <a class="footer-brand" href="index.html#top" aria-label="Guidance System Home">
              <span class="footer-brand__logo" aria-hidden="true"></span>
              <span class="footer-brand__text">Guidance System</span>
            </a>

            <p class="footer__desc">
              Supporting student mental wellness through accessible, confidential counseling
              services.
            </p>
          </div>

          <div class="footer__col">
            <h3 class="footer__title">Quick Links</h3>
            <ul class="footer__list">
              <li><a class="footer__link" href="index.html#home">Home</a></li>
              <li><a class="footer__link" href="index.html#services">Services</a></li>
              <li><a class="footer__link" href="index.html#about">About Us</a></li>
              <li><a class="footer__link" href="index.html#contact">Contact</a></li>
            </ul>
          </div>

          <div class="footer__col">
            <h3 class="footer__title">Resources</h3>
            <ul class="footer__list">
              <li><a class="footer__link" href="privacy.html">Privacy Policy</a></li>
              <li><a class="footer__link" href="terms.html">Terms of Use</a></li>
              <li><a class="footer__link" href="faq.html">FAQ</a></li>
              <li><a class="footer__link" href="support.html">Support</a></li>
            </ul>
          </div>

          <div class="footer__col">
            <h3 class="footer__title">Connect With Us</h3>
            <div class="footer__social">
              <a class="social-btn" href="#" aria-label="Facebook">f</a>
              <a class="social-btn" href="#" aria-label="Twitter">x</a>
              <a class="social-btn" href="#" aria-label="Email">@</a>
            </div>
          </div>
        </div>

        <div class="footer__divider" aria-hidden="true"></div>

        <div class="footer__bottom">
          <p>© <span id="year"></span> Guidance System. All rights reserved.</p>
          <p>Campus Guidance Office</p>
        </div>
      </div>


    <script type="module" src="./admin.js"></script>

    <script type="module">
      import "./site-auth-ui.js";
      import { watchAuthState, isAdminUser } from "./auth-backend.js";

      watchAuthState(async (user) => {
        if (!user) {
          sessionStorage.setItem("postAuthRedirect", "admin-dashboard.html");
          window.location.href = "index.html#login";
          return;
        }

        const ok = await isAdminUser(user);
        if (!ok) {
          window.location.href = "dashboard.html";
          return;
        }

        // ✅ Admin confirmed: allow page to show
        document.documentElement.classList.remove("guard-pending");
      });
    </script>
  </body>
</html>
